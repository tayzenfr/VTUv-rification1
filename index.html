<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Formulaire v√©rification VTU</title>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root{
      --bg0:#020617;
      --bg1:#050b1c;

      --panel: rgba(255,255,255,0.07);
      --stroke: rgba(255,255,255,0.12);

      --text:#eef2ff;
      --muted: rgba(238,242,255,0.74);

      /* Couleurs + glow plus visibles */
      --ok:#22c55e;
      --warn:#fb923c;  /* plus visible que #f97316 */
      --bad:#ff4d6d;   /* rouge/rose plus ‚Äúflashy‚Äù */
      --accent:#38bdf8;

      --glow-ok: 0 0 16px rgba(34,197,94,.35), 0 0 34px rgba(34,197,94,.18);
      --glow-warn: 0 0 16px rgba(251,146,60,.35), 0 0 34px rgba(251,146,60,.18);
      --glow-bad: 0 0 16px rgba(255,77,109,.35), 0 0 34px rgba(255,77,109,.18);
      --glow-accent: 0 0 16px rgba(56,189,248,.30), 0 0 34px rgba(56,189,248,.16);

      --r-lg: 20px;
      --r-md: 16px;
      --pill: 999px;

      --shadow: 0 22px 60px rgba(0,0,0,.60);
      --shadow2: 0 10px 24px rgba(0,0,0,.45);

      --blur: blur(14px) saturate(150%);
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--text);
      min-height: 100vh;
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(56,189,248,.20), transparent 55%),
        radial-gradient(900px 600px at 85% 80%, rgba(34,197,94,.16), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0) 40%, #020617);
      background-attachment: fixed;
      -webkit-tap-highlight-color: transparent;
    }

    header{
      padding: 18px 14px 22px;
      position: relative;
      overflow: hidden;
    }
    header::before{
      content:"";
      position:absolute; inset:-30%;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.10), transparent 55%),
        radial-gradient(circle at 70% 70%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(circle at 20% 80%, rgba(56,189,248,.18), transparent 55%),
        radial-gradient(circle at 85% 20%, rgba(34,197,94,.16), transparent 55%);
      filter: blur(22px);
      opacity: .9;
      pointer-events:none;
      animation: slowFloat 14s ease-in-out infinite alternate;
    }
    h1{
      position: relative;
      text-align:center;
      font-size: clamp(1.25rem, 3.8vw, 1.7rem);
      letter-spacing: .06em;
      text-transform: uppercase;
      text-shadow: 0 10px 24px rgba(0,0,0,.55);
      margin-top: 4px;
    }
    .header-sub{
      position: relative;
      text-align:center;
      margin-top: 6px;
      font-size: .92rem;
      color: rgba(255,255,255,.82);
    }

    main{
      max-width: 980px;
      margin: 0 auto;
      padding: 0 12px 96px;
    }

    .card{
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.04));
      border: 1px solid var(--stroke);
      border-radius: var(--r-lg);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-40% -20%;
      background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,.10) 50%, transparent 65%);
      transform: rotate(10deg);
      opacity: .30;
      pointer-events:none;
      animation: sheen 10s ease-in-out infinite;
    }

    .pad{ padding: 14px; position: relative; }

    .top-strip{
      border-radius: var(--r-md);
      border: 1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(56,189,248,.22), rgba(34,197,94,.14));
      padding: 12px 12px;
      box-shadow: var(--shadow2);
    }
    .top-strip .t1{
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-size: .92rem;
    }
    .top-strip .t2{
      margin-top: 2px;
      color: rgba(255,255,255,.80);
      font-size: .84rem;
    }

    fieldset{
      margin-top: 12px;
      border: 1px solid var(--stroke);
      border-radius: var(--r-md);
      background: rgba(255,255,255,0.03);
      padding: 12px;
    }
    legend{
      padding: 0 8px;
      color: rgba(255,255,255,.90);
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: .82rem;
    }
    .help{
      margin-top: 6px;
      color: var(--muted);
      font-size: .86rem;
      line-height: 1.35;
    }

    .grid2{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    label{
      display:block;
      color: var(--muted);
      font-size: .86rem;
      margin-bottom: 6px;
    }

    input[type="text"], input[type="date"], textarea{
      width:100%;
      background: rgba(0,0,0,.24);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 12px 12px; /* plus ‚Äútouch‚Äù friendly */
      color: var(--text);
      font-size: .98rem;
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease, transform .08s ease, background .15s ease;
    }
    textarea{ min-height: 106px; resize: vertical; }

    input:focus, textarea:focus{
      border-color: rgba(56,189,248,.55);
      box-shadow: 0 0 0 3px rgba(56,189,248,.16), var(--glow-accent);
      transform: translateY(-1px);
      background: rgba(0,0,0,.28);
    }

    /* Stats (on garde) */
    .stats{
      margin-top: 10px;
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .tag{
      border-radius: var(--pill);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      padding: 8px 10px;
      font-size: .82rem;
      color: rgba(255,255,255,.90);
      display:inline-flex;
      align-items:center;
      gap: 6px;
    }
    .tag .k{ color: rgba(238,242,255,0.62); }
    .tag .v{ font-weight: 950; }
    .tag.ok{ border-color: rgba(34,197,94,.45); box-shadow: var(--glow-ok); }
    .tag.warn{ border-color: rgba(251,146,60,.48); box-shadow: var(--glow-warn); }
    .tag.bad{ border-color: rgba(255,77,109,.50); box-shadow: var(--glow-bad); }
    .tag.nr{ border-color: rgba(148,163,184,.34); }

    #itemsContainer{ margin-top: 10px; }

    .row{
      border-radius: var(--r-md);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding: 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 10px;
      transition: border-color .15s ease, transform .12s ease, box-shadow .15s ease, background .15s ease;
    }

    .name{
      font-weight: 950;
      font-size: .98rem;
      letter-spacing: .01em;
    }

    .pills{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 12px 14px; /* plus gros pour t√©l√©phone */
      border-radius: var(--pill);
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.04);
      cursor: pointer;
      user-select:none;
      font-weight: 950;
      font-size: .90rem;
      transition: border-color .15s ease, background .15s ease, transform .08s ease, box-shadow .15s ease;
    }
    .pill:active{ transform: scale(.98); }
    .pill input{ transform: scale(1.12); }

    /* s√©lection + glow fort */
    .pill.sel-ok{
      border-color: rgba(34,197,94,.70);
      background: rgba(34,197,94,.14);
      box-shadow: var(--glow-ok);
    }
    .pill.sel-warn{
      border-color: rgba(251,146,60,.76);
      background: rgba(251,146,60,.15);
      box-shadow: var(--glow-warn);
    }
    .pill.sel-bad{
      border-color: rgba(255,77,109,.80);
      background: rgba(255,77,109,.14);
      box-shadow: var(--glow-bad);
    }

    /* Contour de la ligne selon √©tat (plus visible) */
    .row.st-ok{
      border-color: rgba(34,197,94,.55);
      background: rgba(34,197,94,.06);
      box-shadow: var(--glow-ok);
    }
    .row.st-warn{
      border-color: rgba(251,146,60,.58);
      background: rgba(251,146,60,.06);
      box-shadow: var(--glow-warn);
    }
    .row.st-bad{
      border-color: rgba(255,77,109,.62);
      background: rgba(255,77,109,.06);
      box-shadow: var(--glow-bad);
    }

    .rem{
      background: rgba(0,0,0,.24);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: .95rem;
      color: rgba(255,255,255,.92);
    }
    .rem:focus{
      border-color: rgba(56,189,248,.55);
      box-shadow: 0 0 0 3px rgba(56,189,248,.16), var(--glow-accent);
    }

    /* Actions sticky */
    .actionsSticky{
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(2,6,23,0.00), rgba(2,6,23,0.70) 20%, rgba(2,6,23,0.86));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,.10);
      z-index: 40;
    }
    .actionsBar{
      max-width: 980px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    button{
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 16px;
      padding: 13px 12px;
      font-weight: 950;
      font-size: .95rem;
      cursor:pointer;
      transition: transform .08s ease, filter .15s ease, border-color .15s ease, box-shadow .15s ease;
    }
    button:active{ transform: scale(.98); }

    .btnMain{
      background: linear-gradient(135deg, rgba(56,189,248,.30), rgba(34,197,94,.18));
      color: rgba(255,255,255,.95);
      border-color: rgba(255,255,255,.20);
      box-shadow: var(--glow-accent);
    }
    .btnMain:hover{ filter: brightness(1.05); }

    .btnGhost{
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.92);
    }
    .btnGhost:hover{ border-color: rgba(255,255,255,.20); }

    /* Modal */
    .backdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 14px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index: 60;
    }
    .backdrop.show{ opacity:1; pointer-events:auto; }
    .modal{
      width: min(440px, 100%);
      border-radius: var(--r-lg);
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .mTitle{ font-weight: 950; font-size: 1.0rem; }
    .mText{ margin-top: 8px; color: var(--muted); font-size: .92rem; line-height: 1.35; }
    .mList{ margin-top: 10px; margin-left: 16px; color: var(--muted); font-size: .90rem; }
    .mList li{ margin-bottom: 6px; }
    .mStats{
      margin-top: 10px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius: var(--r-md);
      color: rgba(255,255,255,.90);
      font-size: .92rem;
      line-height: 1.35;
    }
    .mActions{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (min-width: 900px){
      main{ padding-bottom: 26px; }
      .actionsSticky{ position: static; background: transparent; border-top: 0; padding: 0; }
      .actionsBar{ grid-template-columns: 1fr 1fr; }
    }

    @keyframes slowFloat{
      from{ transform: translate(-8px, 6px) scale(1.02); }
      to{ transform: translate(10px, -6px) scale(1.05); }
    }
    @keyframes sheen{
      0%{ transform: translateX(-40%) rotate(10deg); opacity:.0; }
      25%{ opacity:.30; }
      50%{ transform: translateX(40%) rotate(10deg); opacity:.0; }
      100%{ opacity:.0; }
    }
  </style>
</head>

<body>
  <header>
    <h1>Formulaire v√©rification VTU</h1>
    <p class="header-sub">Contr√¥le rapide du mat√©riel (mobile)</p>
  </header>

  <main>
    <div class="card">
      <div class="pad">
        <div class="top-strip">
          <div class="t1">VTU ‚Äì V√©rification</div>
          <div class="t2">Cocher l‚Äô√©tat + remarque si besoin</div>
        </div>

        <form id="inventaireForm" autocomplete="off">
          <fieldset>
            <legend>Informations g√©n√©rales</legend>
            <div class="grid2">
              <div>
                <label for="date">Date du contr√¥le</label>
                <input type="date" id="date" name="date" required />
              </div>
              <div>
                <label for="conducteur">NOM, pr√©nom</label>
                <input type="text" id="conducteur" name="conducteur" placeholder="Nom, pr√©nom" required />
              </div>
            </div>
          </fieldset>

          <fieldset>
            <legend>Mat√©riel VTU</legend>
            <div class="help">√âtat : <b>Pr√©sent</b>, <b>Manquant</b> ou <b>HS</b>. Remarque si n√©cessaire.</div>

            <div class="stats">
              <div class="tag"><span class="k">Total</span> <span class="v" id="statTotal">0</span></div>
              <div class="tag ok"><span class="k">OK</span> <span class="v" id="statOK">0</span></div>
              <div class="tag warn"><span class="k">Manquant</span> <span class="v" id="statManquant">0</span></div>
              <div class="tag bad"><span class="k">HS</span> <span class="v" id="statHS">0</span></div>
              <div class="tag nr"><span class="k">Non renseign√©</span> <span class="v" id="statNon">0</span></div>
            </div>

            <div id="itemsContainer"></div>
          </fieldset>

          <fieldset>
            <legend>Observation g√©n√©rale</legend>
            <label for="observations">Observation g√©n√©rale</label>
            <textarea id="observations" name="observations" placeholder="RAS, mat√©riel manquant, probl√®me particulier‚Ä¶"></textarea>
          </fieldset>
        </form>
      </div>
    </div>
  </main>

  <div class="actionsSticky">
    <div class="actionsBar">
      <button class="btnMain" type="button" id="exportBtn">üì§ Exporter & ouvrir l‚Äôe-mail</button>
      <button class="btnGhost" type="button" id="resetBtn">üîÅ R√©initialiser</button>
    </div>
  </div>

  <div class="backdrop" id="confirmModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
      <div class="mTitle" id="mTitle">Confirmer l‚Äôexport du contr√¥le</div>
      <div class="mText">L‚Äôapplication va :</div>
      <ul class="mList">
        <li>T√©l√©charger un fichier <b>CSV</b> sur cet appareil ;</li>
        <li>Ouvrir la messagerie vers la personne en charge ;</li>
        <li>Joindre le CSV puis envoyer.</li>
      </ul>
      <div class="mStats" id="modalStats"></div>
      <div class="mActions">
        <button class="btnGhost" type="button" id="modalCancel">Retour</button>
        <button class="btnMain" type="button" id="modalConfirm">OK, continuer</button>
      </div>
    </div>
  </div>

  <script>
    const EMAIL_TO = "charpentreaupascal@gmail.com";

    const MATERIAL_ITEMS = [
      "Aspirateur √† eau et chariot","Bidon carburant x4","Paire de botte","Commande","C√¥nes x2",
      "Cuissardes x4","Dagueuse","√âmulseur x4","Lit picot","Lot ANIM","Moto pompe thermique",
      "Groupe √©lectrog√®ne","Pompe √©lectrique","Poubelle","Projecteur portable x2",
      "Raclettes x2 grande et moyenne","Tuyaux diam√®tre 70 x10","Tuyaux diam√®tre 45 x4",
      "Tuyaux diam√®tre 100","Tuyaux Barcelona x5","Tuyaux d'aspiration x4","Caisses d'√©puisement",
      "Polycose","Bouteille plastique","Flotteur","Cr√©pine","Cl√© de poteau","Lance 45 x2",
      "R√©duction 70/45","Pioche","Cl√© de barrage","Sac absorbant","Cales x2","Tuyaux LDT x3",
      "Une masse","Raccord de r√©duction 70/40","LSPCC + commande","Rallonge √©lectrique",
      "Raccord 110/70","Cage √† chat","Couverture","Caisse en polystyr√®ne","Pince reptile",
      "Crochets x2","√âchelle t√©lescopique"
    ];

    let pendingRecord = null;
    const $ = (s) => document.querySelector(s);

    function slug(str){
      return str.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, "_")
        .replace(/^_+|_+$/g, "");
    }

    function renderItems(){
      const container = $("#itemsContainer");
      container.innerHTML = "";

      MATERIAL_ITEMS.forEach(label => {
        const id = "item_" + slug(label);
        const row = document.createElement("div");
        row.className = "row";
        row.dataset.item = label;
        row.dataset.group = id;

        row.innerHTML = `
          <div class="name">${label}</div>
          <div class="pills">
            <label class="pill"><input type="radio" name="${id}" value="OK"> Pr√©sent</label>
            <label class="pill"><input type="radio" name="${id}" value="Manquant"> Manquant</label>
            <label class="pill"><input type="radio" name="${id}" value="HS"> HS</label>
          </div>
          <input class="rem" type="text" placeholder="Remarque (facultatif)" />
        `;

        container.appendChild(row);
      });

      updateStatsFromDOM();
    }

    function buildItems(){
      const items = [];
      document.querySelectorAll(".row").forEach(row => {
        const item = row.dataset.item;
        const group = row.dataset.group;
        const checked = document.querySelector(`input[name="${group}"]:checked`);
        const etat = checked ? checked.value : "Non renseign√©";
        const obs = row.querySelector(".rem").value.trim();
        items.push({ item, etat, obs });
      });
      return items;
    }

    function computeStats(items){
      let total = items.length;
      let ok=0, manquant=0, hs=0, non=0;
      for (const it of items){
        if (it.etat === "OK") ok++;
        else if (it.etat === "Manquant") manquant++;
        else if (it.etat === "HS") hs++;
        else non++;
      }
      return { total, ok, manquant, hs, non };
    }

    function paintRow(row, value){
      row.classList.remove("st-ok","st-warn","st-bad");
      row.querySelectorAll(".pill").forEach(p => p.classList.remove("sel-ok","sel-warn","sel-bad"));

      if (value === "OK") row.classList.add("st-ok");
      if (value === "Manquant") row.classList.add("st-warn");
      if (value === "HS") row.classList.add("st-bad");

      const lab = row.querySelector(`input[value="${value}"]`)?.closest(".pill");
      if (lab){
        if (value === "OK") lab.classList.add("sel-ok");
        if (value === "Manquant") lab.classList.add("sel-warn");
        if (value === "HS") lab.classList.add("sel-bad");
      }
    }

    function updateStatsFromDOM(){
      const items = buildItems();
      const st = computeStats(items);

      $("#statTotal").textContent = st.total;
      $("#statOK").textContent = st.ok;
      $("#statManquant").textContent = st.manquant;
      $("#statHS").textContent = st.hs;
      $("#statNon").textContent = st.non;
    }

    function exportCSV(record){
      const stats = computeStats(record.items);

      const rows = [];
      rows.push("type;date;agent;nbTotal;nbOK;nbManquant;nbHS;nbNonRenseigne;obsGenerale");
      rows.push([
        "VTU",
        record.date,
        record.conducteur,
        stats.total,
        stats.ok,
        stats.manquant,
        stats.hs,
        stats.non,
        (record.observations || "").replace(/;/g, ",")
      ].join(";"));

      rows.push("");
      rows.push("item;etat;remarque");
      for (const it of record.items){
        rows.push([
          it.item,
          it.etat,
          (it.obs || "").replace(/;/g, ",")
        ].join(";"));
      }

      const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const fileName = `controle_vtu_${record.date}.csv`;

      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function openEmail(record){
      const subject = encodeURIComponent(`Contr√¥le VTU du ${record.date} ‚Äì ${record.conducteur}`);

      const body = encodeURIComponent(
`Bonjour,

Le contr√¥le VTU du ${record.date} a √©t√© effectu√© par ${record.conducteur}.

‚ö†Ô∏è IMPORTANT : le fichier du contr√¥le a √©t√© t√©l√©charg√© sur cet appareil.
Avant d'envoyer cet e-mail, veuillez :
1) Joindre le fichier CSV : controle_vtu_${record.date}.csv
2) V√©rifier le contenu, puis envoyer.

Observation g√©n√©rale :
${record.observations || "RAS"}

Cordialement.`
      );

      window.location.href = `mailto:${EMAIL_TO}?subject=${subject}&body=${body}`;
    }

    function openModal(record){
      pendingRecord = record;
      const st = computeStats(record.items);
      $("#modalStats").textContent =
        `R√©cap : Total ${st.total} | OK ${st.ok} ‚Ä¢ Manquant ${st.manquant} ‚Ä¢ HS ${st.hs} ‚Ä¢ Non renseign√© ${st.non}`;
      $("#confirmModal").classList.add("show");
    }

    function closeModal(){
      $("#confirmModal").classList.remove("show");
      pendingRecord = null;
    }

    function validateAndBuildRecord(){
      const date = $("#date").value;
      const conducteur = $("#conducteur").value.trim();
      const observations = $("#observations").value.trim();

      if (!date || !conducteur){
        alert("Merci de remplir la date et le nom.");
        return null;
      }

      return { date, conducteur, observations, items: buildItems() };
    }

    // Events
    $("#itemsContainer").addEventListener("change", (e) => {
      if (e.target.type !== "radio") return;
      const row = e.target.closest(".row");
      if (!row) return;
      paintRow(row, e.target.value);
      updateStatsFromDOM();
    });

    $("#exportBtn").addEventListener("click", () => {
      const record = validateAndBuildRecord();
      if (!record) return;
      openModal(record);
    });

    $("#resetBtn").addEventListener("click", () => {
      if (!confirm("R√©initialiser le formulaire ?")) return;
      $("#inventaireForm").reset();
      document.querySelectorAll(".row").forEach(row => {
        row.classList.remove("st-ok","st-warn","st-bad");
        row.querySelectorAll(".pill").forEach(p => p.classList.remove("sel-ok","sel-warn","sel-bad"));
      });
      updateStatsFromDOM();
    });

    $("#modalCancel").addEventListener("click", closeModal);
    $("#confirmModal").addEventListener("click", (e) => { if (e.target.id === "confirmModal") closeModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

    $("#modalConfirm").addEventListener("click", () => {
      if (!pendingRecord) return;
      exportCSV(pendingRecord);
      openEmail(pendingRecord);
      closeModal();
    });

    // Init
    (function init(){
      renderItems();
      const today = new Date().toISOString().slice(0,10);
      $("#date").value = today;
    })();
  </script>
</body>
</html>
