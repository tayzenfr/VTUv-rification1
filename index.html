<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>formulaire verification VTU</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: #0f172a;
            color: #e5e7eb;
        }
        header {
            background: linear-gradient(135deg, #16a34a, #22c55e);
            padding: 1.7rem 1rem;
            text-align: center;
            color: white;
        }
        h1 { margin: 0; font-size: 1.9rem; }
        h2 {
            margin-top: 2rem;
            border-left: 4px solid #22c55e;
            padding-left: .5rem;
            font-size: 1.25rem;
        }
        main {
            max-width: 1100px;
            margin: 1.5rem auto 3rem;
            padding: 0 1rem;
        }

        form {
            background: #020617;
            border-radius: .9rem;
            padding: 1.5rem 1.2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,.5);
            border: 1px solid #1f2937;
        }
        fieldset {
            border: 1px solid #1f2937;
            border-radius: .7rem;
            margin-bottom: 1.4rem;
            padding: 1.1rem 1.1rem 1rem;
        }
        legend {
            padding: 0 .5rem;
            font-weight: 600;
            color: #22c55e;
            font-size: 1rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 1.1rem;
        }

        label {
            font-size: .95rem;
            display: block;
            margin-bottom: .35rem;
            color: #9ca3af;
        }

        input[type="text"],
        input[type="date"],
        textarea {
            width: 100%;
            padding: .7rem .75rem;
            border-radius: .55rem;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            font-size: 1rem;
        }
        textarea { min-height: 80px; resize: vertical; }

        .item-row {
            display: grid;
            grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.5fr) minmax(0, 1.5fr);
            gap: .85rem;
            align-items: center;
            padding: .55rem .6rem;
            border-radius: .7rem;
            background: #020617;
            border: 1px solid #111827;
            margin-bottom: .55rem;
        }
        .item-name {
            font-size: .95rem;
            font-weight: 500;
        }

        .etat-group {
            display: flex;
            flex-wrap: wrap;
            gap: .45rem;
            font-size: .9rem;
        }
        .etat-group label {
            margin-bottom: 0;
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            padding: .4rem .8rem;
            border-radius: 999px;
            border: 1px solid #374151;
            background: #020617;
        }
        .etat-group input[type="radio"] {
            transform: scale(1.3);
        }

        .small-input {
            font-size: .9rem;
            padding: .5rem .6rem;
            border-radius: .5rem;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            width: 100%;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: .85rem;
            margin-top: 1.2rem;
        }
        button {
            border: none;
            border-radius: .65rem;
            padding: .8rem 1.3rem;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }
        button[type="submit"] {
            background: #22c55e;
            color: #052e16;
        }
        button.secondary {
            background: #111827;
            color: #e5e7eb;
            border: 1px solid #1f2937;
        }
        button.danger {
            background: #b91c1c;
            color: #fee2e2;
        }

        .card {
            background: #020617;
            border-radius: .9rem;
            padding: 1.1rem 1.2rem;
            border: 1px solid #1f2937;
            box-shadow: 0 8px 25px rgba(0,0,0,.4);
            margin-top: 1rem;
        }
        .card-title {
            font-weight: 600;
            margin-bottom: .6rem;
            color: #22c55e;
            font-size: 1rem;
        }
        .tag {
            display: inline-flex;
            align-items: center;
            gap: .25rem;
            padding: .18rem .5rem;
            border-radius: 999px;
            font-size: .75rem;
            background: #111827;
            color: #e5e7eb;
            margin-right: .3rem;
        }
        .tag.ok { color: #6ee7b7; }
        .tag.warn { color: #facc15; }
        .tag.bad { color: #fca5a5; }

        .items-list {
            margin-top: .55rem;
            padding-left: 1rem;
            max-height: 240px;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: .85rem;
            margin-top: .5rem;
        }
        th, td {
            border: 1px solid #1f2937;
            padding: .45rem .5rem;
            text-align: left;
        }
        th {
            background: #020617;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tbody tr:nth-child(even) {
            background: #020617;
        }
        .empty {
            font-size: .9rem;
            color: #9ca3af;
            font-style: italic;
        }

        @media (max-width: 900px) {
            main { padding: 0 .6rem; }
            form { padding: 1.2rem .9rem; }
            .item-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<header>
    <h1>formulaire verification VTU</h1>
</header>

<main>
    <form id="inventaireForm">
        <fieldset>
            <legend>Informations générales</legend>
            <div class="grid-2">
                <div>
                    <label for="date">Date du contrôle</label>
                    <input type="date" id="date" name="date" required>
                </div>
                <div>
                    <label for="conducteur">NOM, prénom</label>
                    <input type="text" id="conducteur" name="conducteur" placeholder="Nom, prénom" required>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend>Matériel VTU</legend>
            <p style="font-size:.9rem;color:#9ca3af;margin-top:0;">
                Pour chaque matériel : <strong>Présent</strong>, <strong>Manquant</strong> ou <strong>HS</strong>, puis observation si besoin.
            </p>
            <div id="itemsContainer"></div>
        </fieldset>

        <fieldset>
            <legend>Observation générale</legend>
            <label for="observations">Observation générale</label>
            <textarea id="observations" name="observations" placeholder=""></textarea>
        </fieldset>

        <div class="actions">
            <button type="submit">Enregistrer le contrôle</button>
            <button type="button" class="secondary" id="exportCsvBtn">Exporter l’historique en CSV</button>
            <button type="button" class="danger" id="clearDataBtn">Vider l’historique (local)</button>
        </div>
    </form>

    <h2>Dernier contrôle enregistré</h2>
    <div id="lastControl" class="card">
        <div class="empty">Aucun contrôle enregistré pour le moment.</div>
    </div>

    <h2>Historique des contrôles (sur ce téléphone / PC)</h2>
    <div class="card" style="max-height: 260px; overflow:auto;">
        <table>
            <thead>
            <tr>
                <th>Date</th>
                <th>Agent</th>
                <th>Résumé matériel</th>
            </tr>
            </thead>
            <tbody id="historyBody">
            <tr><td colspan="3" class="empty">Aucun enregistrement pour l’instant.</td></tr>
            </tbody>
        </table>
        <div style="margin-top:.4rem;font-size:.75rem;color:#9ca3af;">
            ⚠️ Les données sont stockées dans ce navigateur uniquement et sont automatiquement supprimées au bout de 40 jours.
        </div>
    </div>
</main>

<script>
    const STORAGE_KEY = "vtuInventaire";
    const DAYS_TO_KEEP = 40;

    const MATERIAL_ITEMS = [
        "Aspirateur à eau et chariot",
        "Bidon carburant x4",
        "Paire de botte",
        "Commande",
        "Cônes x2",
        "Cuissardes x4",
        "Dagueuse",
        "Émulseur x4",
        "Lit picot",
        "Lot ANIM",
        "Moto pompe thermique",
        "Groupe électrogène",
        "Pompe électrique",
        "Poubelle",
        "Projecteur portable x2",
        "Raclettes x2 grande et moyenne",
        "Tuyaux diamètre 70 x10",
        "Tuyaux diamètre 45 x4",
        "Tuyaux diamètre 100",
        "Tuyaux Barcelona x5",
        "Tuyaux d'aspiration x4",
        "Caisses d'épuisement",
        "Polycose",
        "Bouteille plastique",
        "Flotteur",
        "Crépine",
        "Clé de poteau",
        "Lance 45 x2",
        "Réduction 70/45",
        "Pioche",
        "Clé de barrage",
        "Sac absorbant",
        "Cales x2",
        "Tuyaux LDT x3",
        "Une masse",
        "Raccord de réduction 70/40",
        "LSPCC + commande",
        "Rallonge électrique",
        "Raccord 110/70",
        "Cage à chat",
        "Couverture",
        "Caisse en polystyrène",
        "Pince reptile",
        "Crochets x2",
        "Échelle télescopique"
    ];

    function slug(str) {
        return str
            .toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9]+/g, "_")
            .replace(/^_+|_+$/g, "");
    }

    function renderItemRows() {
        const container = document.getElementById("itemsContainer");
        container.innerHTML = "";
        MATERIAL_ITEMS.forEach(label => {
            const id = "item_" + slug(label);
            const row = document.createElement("div");
            row.className = "item-row";
            row.dataset.item = label;
            row.dataset.group = id;
            row.innerHTML = `
                <div class="item-name">${label}</div>
                <div class="etat-group">
                    <label><input type="radio" name="${id}" value="OK"> Présent</label>
                    <label><input type="radio" name="${id}" value="Manquant"> Manquant</label>
                    <label><input type="radio" name="${id}" value="HS"> HS</label>
                </div>
                <div>
                    <input class="small-input" type="text" placeholder="Observation">
                </div>
            `;
            container.appendChild(row);
        });
    }

    function loadRecordsRaw() {
        try {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    function saveRecords(records) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    function purgeOld(records) {
        const now = new Date();
        const limit = now.getTime() - DAYS_TO_KEEP * 24 * 60 * 60 * 1000;
        return records.filter(rec => {
            if (!rec.date) return true;
            const ts = Date.parse(rec.date);
            if (isNaN(ts)) return true;
            return ts >= limit;
        });
    }

    function loadRecords() {
        let records = loadRecordsRaw();
        records = purgeOld(records);
        saveRecords(records);
        return records;
    }

    function buildItemsFromForm() {
        const items = [];
        document.querySelectorAll(".item-row").forEach(row => {
            const itemName = row.dataset.item;
            const group = row.dataset.group;
            const checked = document.querySelector(`input[name="${group}"]:checked`);
            const etat = checked ? checked.value : "Non renseigné";
            const remarqueInput = row.querySelector('input[type="text"]');
            const remarque = remarqueInput ? remarqueInput.value.trim() : "";
            items.push({ itemName, etat, remarque });
        });
        return items;
    }

    function renderLastControl(record) {
        const container = document.getElementById("lastControl");
        container.innerHTML = "";
        if (!record) {
            container.innerHTML = '<div class="empty">Aucun contrôle enregistré pour le moment.</div>';
            return;
        }

        const okCount = record.items.filter(i => i.etat === "OK").length;
        const manqCount = record.items.filter(i => i.etat === "Manquant").length;
        const hsCount = record.items.filter(i => i.etat === "HS").length;

        const header = document.createElement("div");
        header.className = "card-title";
        header.textContent = `${record.date} – ${record.conducteur}`;

        const tags = document.createElement("div");
        tags.innerHTML = `
            <span class="tag ok">OK : ${okCount}</span>
            <span class="tag warn">Manquant : ${manqCount}</span>
            <span class="tag bad">HS : ${hsCount}</span>
        `;

        const list = document.createElement("ul");
        list.className = "items-list";
        record.items.forEach(it => {
            const li = document.createElement("li");
            li.style.fontSize = ".85rem";
            let cls = "";
            if (it.etat === "OK") cls = "ok";
            else if (it.etat === "Manquant") cls = "warn";
            else if (it.etat === "HS") cls = "bad";

            li.innerHTML = `<span class="tag ${cls}">${it.etat}</span> ${it.itemName}` +
                (it.remarque ? ` – <span style="color:#9ca3af;">${it.remarque}</span>` : "");
            list.appendChild(li);
        });

        const anomalies = record.items.filter(
            it => it.etat !== "OK" || (it.remarque && it.remarque.trim() !== "")
        );
        let anomaliesBlock = "";
        if (anomalies.length) {
            const ul = anomalies.map(it => {
                const info = [];
                if (it.etat !== "OK") info.push(it.etat);
                if (it.remarque) info.push(it.remarque);
                return `<li>${it.itemName} – ${info.join(" / ")}</li>`;
            }).join("");
            anomaliesBlock = `
                <div style="margin-top:.7rem;font-size:.9rem;">
                    <strong>Points à surveiller :</strong>
                    <ul style="margin-top:.25rem;padding-left:1rem;">
                        ${ul}
                    </ul>
                </div>
            `;
        }

        const obs = document.createElement("div");
        obs.style.marginTop = ".5rem";
        obs.style.fontSize = ".9rem";
        obs.style.color = "#9ca3af";
        obs.innerHTML = `<strong>Observation générale :</strong> ${record.observations || "RAS"}`;

        container.appendChild(header);
        container.appendChild(tags);
        container.appendChild(list);
        container.insertAdjacentHTML("beforeend", anomaliesBlock);
        container.appendChild(obs);
    }

    function renderHistory(records) {
        const tbody = document.getElementById("historyBody");
        tbody.innerHTML = "";

        if (!records.length) {
            tbody.innerHTML = '<tr><td colspan="3" class="empty">Aucun enregistrement pour l’instant.</td></tr>';
            return;
        }

        const last = records.slice().reverse().slice(0, 15);
        last.forEach(rec => {
            const tr = document.createElement("tr");
            const okCount = rec.items.filter(i => i.etat === "OK").length;
            const manqCount = rec.items.filter(i => i.etat === "Manquant").length;
            const hsCount = rec.items.filter(i => i.etat === "HS").length;

            tr.innerHTML = `
                <td>${rec.date}</td>
                <td>${rec.conducteur}</td>
                <td>
                    <span class="tag ok">OK ${okCount}</span>
                    <span class="tag warn">M ${manqCount}</span>
                    <span class="tag bad">HS ${hsCount}</span>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function exportCSV() {
        const records = loadRecords();
        if (!records.length) {
            alert("Aucun enregistrement à exporter.");
            return;
        }

        let rows = ["date;agent;item;etat;remarque;obsGenerale"];
        records.forEach(rec => {
            rec.items.forEach(it => {
                const safeRemarque = (it.remarque || "").replace(/;/g, ",");
                const safeObs = (rec.observations || "").replace(/;/g, ",");
                rows.push([
                    rec.date,
                    rec.conducteur,
                    it.itemName,
                    it.etat,
                    safeRemarque,
                    safeObs
                ].join(";"));
            });
        });

        const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "verification_vtu.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function clearData() {
        if (!confirm("Tu es sûr de vouloir supprimer tout l’historique local ?")) return;
        saveRecords([]);
        renderLastControl(null);
        renderHistory([]);
    }

    document.getElementById("inventaireForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const form = e.target;

        const record = {
            date: form.date.value,
            conducteur: form.conducteur.value.trim(),
            observations: form.observations.value.trim(),
            items: buildItemsFromForm()
        };

        let records = loadRecords(); // purge incluse
        records.push(record);
        records = purgeOld(records);
        saveRecords(records);

        renderLastControl(record);
        renderHistory(records);

        alert("Contrôle VTU enregistré sur ce téléphone / PC !");
    });

    document.getElementById("exportCsvBtn").addEventListener("click", exportCSV);
    document.getElementById("clearDataBtn").addEventListener("click", clearData);

    (function init() {
        renderItemRows();
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById("date").value = today;

        const records = loadRecords();
        if (records.length) {
            renderLastControl(records[records.length - 1]);
            renderHistory(records);
        } else {
            renderLastControl(null);
            renderHistory([]);
        }
    })();
</script>
</body>
</html>
