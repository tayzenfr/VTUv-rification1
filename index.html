<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Formulaire v√©rification VTU</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg: #020617;
            --bg-soft: #020818;
            --border: #1f2937;
            --accent: #22c55e;
            --accent-strong: #16a34a;
            --accent-blue: #0ea5e9;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --radius-lg: 18px;
            --radius-md: 12px;
            --radius-pill: 999px;
            --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.6);
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background:
                radial-gradient(circle at top left, rgba(34,197,94,0.12), transparent 55%),
                radial-gradient(circle at bottom right, rgba(14,165,233,0.14), transparent 55%),
                #020617;
            color: var(--text);
            min-height: 100vh;
        }

        /* ========= HEADER ========= */

        header {
            position: relative;
            background: linear-gradient(135deg, #16a34a, #22c55e, #0ea5e9);
            padding: 1.8rem 1rem 2.3rem;
            text-align: center;
            color: white;
            overflow: hidden;
        }

        header::before {
            content: "";
            position: absolute;
            inset: -40%;
            background:
                radial-gradient(circle at 10% 0%, rgba(34,197,94,0.4), transparent 55%),
                radial-gradient(circle at 90% 100%, rgba(56,189,248,0.35), transparent 55%);
            opacity: 0.8;
            filter: blur(22px);
            animation: headerGlow 18s ease-in-out infinite alternate;
            pointer-events: none;
        }

        header * {
            position: relative;
        }

        h1 {
            margin: 0;
            font-size: clamp(1.5rem, 2.4vw, 2rem);
            letter-spacing: .06em;
            text-transform: uppercase;
            text-shadow: 0 6px 20px rgba(0,0,0,0.55);
        }

        .header-sub {
            margin-top: .4rem;
            font-size: .9rem;
            opacity: .95;
        }

        /* ========= MAIN / FORM ========= */

        main {
            max-width: 1020px;
            margin: -1.4rem auto 3rem;
            padding: 0 .9rem 2.4rem;
            position: relative;
            z-index: 1;
        }

        form {
            background: rgba(2, 6, 23, 0.98);
            border-radius: var(--radius-lg);
            padding: 1.4rem 1.3rem 1.4rem;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(148,163,184,0.18);
            backdrop-filter: blur(12px);
            animation: cardIn .5s cubic-bezier(.16,1,.3,1);
        }

        /* ========= BANDEAU VTU ========= */

        .form-header {
            background: linear-gradient(120deg, #16a34a, #22c55e, #0ea5e9);
            border-radius: var(--radius-md);
            padding: .75rem .95rem;
            margin-bottom: 1.1rem;
            display: flex;
            flex-direction: column;
            gap: .18rem;
            color: #ecfdf5;
            box-shadow: 0 10px 25px rgba(15,118,110,0.45);
        }

        .form-header-title {
            font-size: .95rem;
            font-weight: 700;
            letter-spacing: .1em;
            text-transform: uppercase;
        }

        .form-header-sub {
            font-size: .82rem;
            opacity: .95;
        }

        /* ========= FIELDSETS ========= */

        fieldset {
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            margin-bottom: 1.1rem;
            padding: 1rem .95rem .95rem;
            background: rgba(15,23,42,0.95);
        }

        legend {
            padding: 0 .45rem;
            font-weight: 600;
            color: var(--accent);
            font-size: .9rem;
            text-transform: uppercase;
            letter-spacing: .08em;
        }

        .legend-help {
            font-size: .85rem;
            color: var(--muted);
            margin-top: .25rem;
        }

        /* ========= GRID ========= */

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: .9rem;
        }

        /* ========= LABELS / INPUTS ========= */

        label {
            font-size: .85rem;
            display: block;
            margin-bottom: .28rem;
            color: var(--muted);
        }

        input[type="text"],
        input[type="date"],
        textarea {
            width: 100%;
            padding: .65rem .75rem;
            border-radius: .55rem;
            border: 1px solid #1f2937;
            background: #020617;
            color: var(--text);
            font-size: .9rem;
            transition: border-color .16s ease, box-shadow .16s ease, background .16s ease,
                        transform .08s ease;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(34,197,94,0.5), 0 0 12px rgba(34,197,94,0.25);
            background: #02041b;
            transform: translateY(-1px);
        }

        /* ========= ITEMS ========= */

        .item-row {
            display: grid;
            grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.4fr) minmax(0, 1.4fr);
            gap: .75rem;
            align-items: center;
            padding: .55rem .65rem;
            border-radius: .75rem;
            background: #020617;
            border: 1px solid #0b1220;
            margin-bottom: .45rem;
            transition: border-color .16s ease, background .16s ease, transform .08s ease,
                        box-shadow .12s ease;
        }

        .item-row:hover {
            border-color: rgba(34,197,94,0.5);
            background: #020b1a;
            transform: translateY(-1px);
            box-shadow: 0 0 16px rgba(34,197,94,0.25);
        }

        .item-name {
            font-size: .9rem;
            font-weight: 500;
        }

        .etat-group {
            display: flex;
            flex-wrap: wrap;
            gap: .35rem;
            font-size: .8rem;
        }

        .etat-group label {
            margin-bottom: 0;
            display: inline-flex;
            align-items: center;
            gap: .3rem;
            padding: .32rem .7rem;
            border-radius: var(--radius-pill);
            border: 1px solid #334155;
            background: #020617;
            cursor: pointer;
            transition: background .14s ease, border-color .14s ease, transform .08s ease,
                        box-shadow .12s ease;
        }

        .etat-group label:hover {
            border-color: rgba(148,163,184,0.85);
            background: #020a18;
            box-shadow: 0 0 10px rgba(148,163,184,0.35);
        }

        .etat-group input[type="radio"] {
            transform: scale(1.15);
        }

        .small-input {
            font-size: .8rem;
            padding: .45rem .6rem;
            border-radius: .5rem;
            border: 1px solid #1f2937;
            background: #020617;
            color: var(--text);
        }

        /* ========= ACTIONS ========= */

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: .75rem;
            margin-top: 1rem;
        }

        button {
            border: none;
            border-radius: .7rem;
            padding: .78rem 1.3rem;
            font-weight: 600;
            cursor: pointer;
            font-size: .9rem;
            display: inline-flex;
            align-items: center;
            gap: .45rem;
            transition: transform .08s ease, box-shadow .14s ease, background .14s ease,
                        filter .14s ease;
        }

        button[type="submit"] {
            background: linear-gradient(135deg, #16a34a, #22c55e, #0ea5e9);
            color: #022c22;
            box-shadow:
                0 10px 22px rgba(16,185,129,0.5),
                0 0 16px rgba(14,165,233,0.35);
        }

        button[type="submit"]:hover {
            transform: translateY(-1px);
            filter: brightness(1.03);
            box-shadow:
                0 14px 28px rgba(16,185,129,0.6),
                0 0 18px rgba(14,165,233,0.45);
        }

        button.secondary {
            background: #020617;
            color: var(--text);
            border: 1px solid #1f2937;
            box-shadow: 0 0 10px rgba(15,23,42,0.6);
        }

        button.secondary:hover {
            background: #020b24;
            transform: translateY(-1px);
            box-shadow: 0 0 14px rgba(148,163,184,0.4);
        }

        /* ========= MODAL ========= */

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.75);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity .18s ease;
            z-index: 50;
        }

        .modal-backdrop.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: #020617;
            border-radius: 16px;
            padding: 1.2rem 1.1rem 1rem;
            max-width: 420px;
            width: calc(100% - 2.4rem);
            border: 1px solid rgba(148,163,184,0.3);
            box-shadow: 0 22px 40px rgba(0,0,0,0.7);
            animation: modalIn .18s ease-out;
        }

        .modal-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: .5rem;
        }

        .modal-text {
            font-size: .85rem;
            color: var(--muted);
            margin-bottom: .7rem;
        }

        .modal-list {
            font-size: .82rem;
            color: var(--muted);
            margin-left: 1rem;
            margin-bottom: .8rem;
        }

        .modal-list li {
            margin-bottom: .25rem;
        }

        .modal-actions {
            display: flex;
            gap: .6rem;
            justify-content: flex-end;
            margin-top: .4rem;
        }

        .btn-ghost {
            background: transparent;
            color: var(--muted);
            border: 1px solid #374151;
            box-shadow: none;
        }

        .btn-ghost:hover {
            background: #020617;
            box-shadow: 0 0 10px rgba(148,163,184,0.35);
        }

        .btn-primary {
            background: linear-gradient(135deg, #16a34a, #22c55e, #0ea5e9);
            color: #022c22;
            box-shadow:
                0 8px 18px rgba(16,185,129,0.5),
                0 0 14px rgba(14,165,233,0.35);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow:
                0 10px 22px rgba(16,185,129,0.6),
                0 0 18px rgba(14,165,233,0.5);
        }

        /* ========= RESPONSIVE ========= */

        @media (max-width: 768px) {
            main {
                padding-inline: .7rem;
            }
            form {
                padding: 1.2rem 1rem 1.3rem;
                border-radius: 16px;
            }
            .item-row {
                grid-template-columns: 1fr;
                padding: .6rem .65rem;
            }
            .actions {
                flex-direction: column;
            }
            button {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            header {
                padding-inline: .8rem;
            }
            .header-sub {
                font-size: .82rem;
            }
            .form-header {
                padding: .65rem .75rem;
            }
            .form-header-title {
                font-size: .9rem;
            }
            .form-header-sub {
                font-size: .78rem;
            }
        }

        /* ========= ANIMATIONS ========= */

        @keyframes cardIn {
            from {
                opacity: 0;
                transform: translateY(12px) scale(.985);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes headerGlow {
            from {
                transform: translate3d(-10px, 5px, 0) scale(1.01);
            }
            to {
                transform: translate3d(10px, -5px, 0) scale(1.05);
            }
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(.97);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>
<body>
<header>
    <h1>Formulaire v√©rification VTU</h1>
    <p class="header-sub">Contr√¥le rapide et propre du mat√©riel du VTU</p>
</header>

<main>
    <form id="inventaireForm">
        <!-- BANDEAU VTU AVEC D√âGRAD√â VERT / BLEU -->
        <div class="form-header">
            <div class="form-header-title">VTU ‚Äì V√©rification</div>
            <div class="form-header-sub">Contr√¥le journalier du mat√©riel et observations</div>
        </div>

        <fieldset>
            <legend>Informations g√©n√©rales</legend>
            <div class="grid-2">
                <div>
                    <label for="date">Date du contr√¥le</label>
                    <input type="date" id="date" name="date" required>
                </div>
                <div>
                    <label for="conducteur">NOM, pr√©nom</label>
                    <input type="text" id="conducteur" name="conducteur" placeholder="Nom, pr√©nom" required>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend>Mat√©riel VTU</legend>
            <p class="legend-help">
                Pour chaque mat√©riel : <strong>Pr√©sent</strong>, <strong>Manquant</strong> ou <strong>HS</strong>, avec remarque si besoin.
            </p>
            <div id="itemsContainer"></div>
        </fieldset>

        <fieldset>
            <legend>Observation g√©n√©rale</legend>
            <label for="observations">Observation g√©n√©rale</label>
            <textarea id="observations" name="observations" placeholder="RAS, mat√©riel manquant, probl√®me particulier‚Ä¶"></textarea>
        </fieldset>

        <div class="actions">
            <button type="submit">üì§ Exporter le contr√¥le & ouvrir l‚Äôe-mail</button>
            <button type="button" class="secondary" id="resetFormBtn">üîÅ R√©initialiser le formulaire</button>
        </div>
    </form>
</main>

<!-- MODAL DE CONFIRMATION -->
<div class="modal-backdrop" id="confirmModal">
    <div class="modal">
        <div class="modal-title">Confirmer l‚Äôexport du contr√¥le</div>
        <div class="modal-text">
            En validant, l‚Äôapplication va :
        </div>
        <ul class="modal-list">
            <li>T√©l√©charger un fichier <strong>CSV</strong> du contr√¥le VTU sur cet appareil ;</li>
            <li>Ouvrir ta messagerie (ex : Gmail) vers la personne en charge ;</li>
            <li>Tu devras ensuite <strong>joindre le fichier CSV</strong> avant d‚Äôenvoyer l‚Äôe-mail.</li>
        </ul>
        <div class="modal-text">
            Veux-tu continuer ?
        </div>
        <div class="modal-actions">
            <button type="button" class="btn-ghost" id="modalCancel">Retour</button>
            <button type="button" class="btn-primary" id="modalConfirm">OK, continuer</button>
        </div>
    </div>
</div>

<script>
    const EMAIL_TO = "charpentreaupascal@gmail.com";

    const MATERIAL_ITEMS = [
        "Aspirateur √† eau et chariot","Bidon carburant x4","Paire de botte","Commande","C√¥nes x2",
        "Cuissardes x4","Dagueuse","√âmulseur x4","Lit picot","Lot ANIM","Moto pompe thermique",
        "Groupe √©lectrog√®ne","Pompe √©lectrique","Poubelle","Projecteur portable x2",
        "Raclettes x2 grande et moyenne","Tuyaux diam√®tre 70 x10","Tuyaux diam√®tre 45 x4",
        "Tuyaux diam√®tre 100","Tuyaux Barcelona x5","Tuyaux d'aspiration x4","Caisses d'√©puisement",
        "Polycose","Bouteille plastique","Flotteur","Cr√©pine","Cl√© de poteau","Lance 45 x2",
        "R√©duction 70/45","Pioche","Cl√© de barrage","Sac absorbant","Cales x2","Tuyaux LDT x3",
        "Une masse","Raccord de r√©duction 70/40","LSPCC + commande","Rallonge √©lectrique",
        "Raccord 110/70","Cage √† chat","Couverture","Caisse en polystyr√®ne","Pince reptile",
        "Crochets x2","√âchelle t√©lescopique"
    ];

    let pendingRecord = null;

    function slug(str) {
        return str.toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9]+/g, "_")
            .replace(/^_+|_+$/g, "");
    }

    function renderItemRows() {
        const container = document.getElementById("itemsContainer");
        container.innerHTML = "";
        MATERIAL_ITEMS.forEach(label => {
            const id = "item_" + slug(label);
            container.insertAdjacentHTML("beforeend", `
                <div class="item-row" data-item="${label}" data-group="${id}">
                    <div class="item-name">${label}</div>
                    <div class="etat-group">
                        <label><input type="radio" name="${id}" value="OK"> Pr√©sent</label>
                        <label><input type="radio" name="${id}" value="Manquant"> Manquant</label>
                        <label><input type="radio" name="${id}" value="HS"> HS</label>
                    </div>
                    <div>
                        <input class="small-input" type="text" placeholder="Observation (facultatif)">
                    </div>
                </div>
            `);
        });
    }

    function buildItems() {
        const items = [];
        document.querySelectorAll(".item-row").forEach(row => {
            const item = row.dataset.item;
            const group = row.dataset.group;
            const checked = document.querySelector(`input[name="${group}"]:checked`);
            const etat = checked ? checked.value : "Non renseign√©";
            const obs = row.querySelector("input[type=text]").value.trim();
            items.push({ item, etat, obs });
        });
        return items;
    }

    function exportCSV(record) {
        let rows = ["date;agent;item;etat;remarque;obsGenerale"];
        record.items.forEach(it => {
            rows.push([
                record.date,
                record.conducteur,
                it.item,
                it.etat,
                it.obs.replace(/;/g, ","),
                record.observations.replace(/;/g, ",")
            ].join(";"));
        });

        const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const fileName = `controle_vtu_${record.date}.csv`;

        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    function openEmail(record) {
        const subject = encodeURIComponent(`Contr√¥le VTU du ${record.date} ‚Äì ${record.conducteur}`);

        const body = encodeURIComponent(
`Bonjour,

Le contr√¥le VTU du ${record.date} a √©t√© effectu√© par ${record.conducteur}.

‚ö†Ô∏è IMPORTANT : le fichier du contr√¥le a √©t√© t√©l√©charg√© sur cet appareil.
Avant d'envoyer cet e-mail, veuillez :

1) Cliquer sur "Joindre un fichier" dans Gmail.
2) S√©lectionner le fichier CSV nomm√© :
   controle_vtu_${record.date}.csv
3) V√©rifier le contenu, puis cliquer sur "Envoyer".

Observation g√©n√©rale :
${record.observations || "RAS"}

Cordialement.`
        );

        window.location.href = `mailto:${EMAIL_TO}?subject=${subject}&body=${body}`;
    }

    function openModal(record) {
        pendingRecord = record;
        document.getElementById("confirmModal").classList.add("show");
    }

    function closeModal() {
        document.getElementById("confirmModal").classList.remove("show");
        pendingRecord = null;
    }

    // ====== EVENTS ======

    document.getElementById("inventaireForm").addEventListener("submit", e => {
        e.preventDefault();

        const record = {
            date: e.target.date.value,
            conducteur: e.target.conducteur.value.trim(),
            observations: e.target.observations.value.trim(),
            items: buildItems()
        };

        if (!record.date || !record.conducteur) {
            alert("Merci de remplir la date et le nom.");
            return;
        }

        // Ouvre la popup au lieu du confirm()
        openModal(record);
    });

    document.getElementById("resetFormBtn").addEventListener("click", () => {
        if (confirm("R√©initialiser le formulaire ?")) {
            document.getElementById("inventaireForm").reset();
        }
    });

    // Bouton retour de la modal
    document.getElementById("modalCancel").addEventListener("click", () => {
        closeModal();
    });

    // Bouton OK de la modal
    document.getElementById("modalConfirm").addEventListener("click", () => {
        if (!pendingRecord) return;
        exportCSV(pendingRecord);
        openEmail(pendingRecord);
        closeModal();
    });

    // Fermer si on clique en dehors de la fen√™tre
    document.getElementById("confirmModal").addEventListener("click", (e) => {
        if (e.target.id === "confirmModal") {
            closeModal();
        }
    });

    (function init() {
        renderItemRows();
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById("date").value = today;
    })();
</script>

</body>
</html>
